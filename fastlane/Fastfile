# Fastfile for TapTap iOS SDK Release Automation
#
# ä½¿ç”¨æ–¹æ³•:
#   fastlane release version:4.7.4
#   fastlane release_to_cocoapods

default_platform(:ios)

platform :ios do
  # å‘å¸ƒåˆ° CocoaPods
  # è¿™ä¸ª lane ä¼šéªŒè¯å¹¶å‘å¸ƒ podspec åˆ° CocoaPods Trunk
  desc "Release SDK to CocoaPods"
  lane :release_to_cocoapods do
    # 1. æ›´æ–° CocoaPods ä»“åº“
    sh("pod repo update")

    # 2. éªŒè¯ podspec æ–‡ä»¶æ ¼å¼ï¼ˆä» Git ä»“åº“éªŒè¯ï¼‰
    podspec_path = File.expand_path("../PodSpecs/TapTapSDK.podspec", __dir__)
    sh("pod spec lint #{podspec_path} --allow-warnings --verbose --skip-import-validation")

    # 3. å‘å¸ƒåˆ° CocoaPods Trunk
    sh("pod trunk push #{podspec_path} --allow-warnings --verbose")

    UI.success("âœ… Successfully published TapTapSDK to CocoaPods!")
  end

  # å®Œæ•´çš„å‘å¸ƒæµç¨‹
  # åŒ…å«ç‰ˆæœ¬éªŒè¯ã€GitHub Release åˆ›å»ºã€CocoaPods å‘å¸ƒ
  desc "Full release process with version validation"
  lane :release do |options|
    # è·å–ç‰ˆæœ¬å·
    version = options[:version]

    if version.nil?
      UI.user_error!("âŒ Please specify version number: fastlane release version:4.7.4")
    end

    UI.message("ğŸš€ Starting release process for version #{version}")

    # 1. éªŒè¯ podspec ç‰ˆæœ¬å·ä¸å‚æ•°æ˜¯å¦åŒ¹é…
    podspec_version = version_get_podspec(path: "PodSpecs/TapTapSDK.podspec")

    if podspec_version != version
      UI.user_error!("âŒ Podspec version (#{podspec_version}) does not match specified version (#{version})")
    end

    UI.success("âœ… Version check passed: #{version}")

    # 2. å‘å¸ƒåˆ° CocoaPods
    release_to_cocoapods

    UI.success("ğŸ‰ Release #{version} completed successfully!")
  end

  # ä»…éªŒè¯ podspecï¼Œä¸å‘å¸ƒ
  desc "Validate podspec without publishing"
  lane :validate do
    # æ›´æ–° CocoaPods ä»“åº“
    sh("pod repo update")

    # ä½¿ç”¨ pod spec lint ä» Git ä»“åº“éªŒè¯
    podspec_path = File.expand_path("../PodSpecs/TapTapSDK.podspec", __dir__)
    sh("pod spec lint #{podspec_path} --allow-warnings --verbose --skip-import-validation")

    UI.success("âœ… Podspec validation passed!")
  end
end
