name: Release iOS SDK

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€ç‰ˆæœ¬ tag æ—¶è‡ªåŠ¨è¿è¡Œ
# æ”¯æŒæ ¼å¼ï¼šv1.0.0 æˆ– 1.0.0
on:
  push:
    tags:
      - 'v*.*.*'
      - '*.*.*'

jobs:
  # Job 1: åˆ›å»º GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: tapsdk-linux-x64-16c  # ä½¿ç”¨è‡ªå®šä¹‰ Linux runner
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release

    steps:
      # Step 1: æ£€å‡ºä»£ç 
      # fetch-depth: 0 è¡¨ç¤ºè·å–å®Œæ•´çš„ git å†å²ï¼Œä»¥ä¾¿åç»­æ“ä½œ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: ä» tag ä¸­æå–ç‰ˆæœ¬å·
      # ä¾‹å¦‚ï¼šv4.7.3 -> 4.7.3
      - name: Extract version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION} from tag: ${TAG_NAME}"

      # Step 3: åˆ›å»º GitHub Release
      # åˆ›å»ºæ­£å¼ç‰ˆæœ¬å‘å¸ƒï¼Œä½¿ç”¨ GitHub è‡ªåŠ¨ç”Ÿæˆçš„ release notes
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag_name }}
          name: Release ${{ steps.get_version.outputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 2: ä½¿ç”¨ Fastlane å‘å¸ƒåˆ° CocoaPods
  # ä¾èµ–äº create-release job å®Œæˆåæ‰æ‰§è¡Œ
  publish-cocoapods:
    name: Publish to CocoaPods with Fastlane
    needs: create-release
    runs-on: macos-15-xlarge  # ä½¿ç”¨è‡ªå®šä¹‰ macOS runner (macOS 15, XLarge)

    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: è®¾ç½® Ruby ç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
      # ä½¿ç”¨ Bundler è‡ªåŠ¨å®‰è£… Gemfile ä¸­æŒ‡å®šçš„ Fastlane å’Œ CocoaPods
      # bundler-cache: true ä¼šè‡ªåŠ¨ç¼“å­˜ gemsï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦
      - name: Set up Ruby and install dependencies
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      # Step 3: ä» tag ä¸­æå–ç‰ˆæœ¬å·
      - name: Extract version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION} from tag: ${TAG_NAME}"

      # Step 4: ä½¿ç”¨ Fastlane å‘å¸ƒåˆ° CocoaPods
      # Fastlane ä¼šè‡ªåŠ¨å¤„ç†ç‰ˆæœ¬éªŒè¯ã€podspec éªŒè¯å’Œå‘å¸ƒæµç¨‹
      - name: Release to CocoaPods using Fastlane
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          if [ -z "$COCOAPODS_TRUNK_TOKEN" ]; then
            echo "âŒ Error: COCOAPODS_TRUNK_TOKEN is not set"
            echo "Please add your CocoaPods Trunk token to GitHub Secrets"
            exit 1
          fi

          echo "ğŸš€ Starting Fastlane release process..."
          bundle exec fastlane release version:${{ steps.get_version.outputs.version }}

      # Step 5: å‘å¸ƒæˆåŠŸæç¤º
      - name: Release completed
        run: |
          echo "âœ… Successfully published TapTapSDK ${{ steps.get_version.outputs.version }} to CocoaPods"
          echo "It may take a few minutes for the new version to be available in CocoaPods search"
